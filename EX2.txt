CREATE TABLE NHACC (
	MaNCC VARCHAR(6) PRIMARY KEY NOT NULL,
	TenNCC VARCHAR(100),
	DiaChiNCC VARCHAR(100),
	DTNCC VARCHAR(100)
);
CREATE TABLE KH (
	MaKH VARCHAR(6) PRIMARY KEY NOT NULL,
	TenKH VARCHAR(100),
	DCKH VARCHAR(100),
	DTKH VARCHAR(100)
);

CREATE TABLE LOAINGK(
	MaLoaiNGK VARCHAR(6) PRIMARY KEY NOT NULL,
	TenLoaiNGK VARCHAR(100),
	MaNCC VARCHAR(6) REFERENCES NHACC(MaNCC) NOT NULL,
);
CREATE TABLE NGK(
	MaNGK VARCHAR(6) PRIMARY KEY NOT NULL,
	TenNGK VARCHAR(100),
	Quycach VARCHAR(100),
	MaLoaiNGK VARCHAR(6) REFERENCES LOAINGK(MaLoaiNGK) NOT NULL,
);

CREATE TABLE DDH (
	SoDDH VARCHAR(6) PRIMARY KEY NOT NULL,
	NgayDH DATE,
	MaNCC VARCHAR(6) REFERENCES NHACC(MaNCC) NOT NULL,
);

CREATE TABLE CT_DDH (
	SoDDH VARCHAR(6),
	MaNGK VARCHAR(6),
	SLDat INT,
	PRIMARY KEY (SoDDH,MaNGK),
	FOREIGN KEY (SoDDH) REFERENCES DDH(SoDDH),
	FOREIGN KEY (MaNGK) REFERENCES NGK(MaNGK),
);

CREATE TABLE PHIEUGH (
	SoPGH VARCHAR(6) PRIMARY KEY NOT NULL,
	NgayGH DATE,
	SoDDH VARCHAR(6) REFERENCES DDH(SoDDH),
);

CREATE TABLE CT_PGH (
	SoPGH VARCHAR(6),
	MaNGK VARCHAR(6),
	SLGiao INT,
	DGGiao MONEY,
	PRIMARY KEY (SoPGH,MaNGK),
	FOREIGN KEY (SoPGH) REFERENCES PHIEUGH(SoPGH),
	FOREIGN KEY (MaNGK) REFERENCES NGK(MaNGK),
);

CREATE TABLE HOADON (
	SoHD VARCHAR(6) PRIMARY KEY NOT NULL,
	NgaylapHD DATE,
	MaKH VARCHAR(6) REFERENCES KH(MaKH),
);

CREATE TABLE CT_HOADON (
	SoHD VARCHAR(6),
	MaNGK VARCHAR(6),
	SLKHMua INT,
	DGBan MONEY,
	PRIMARY KEY (SoHD,MaNGK),
	FOREIGN KEY (SoHD) REFERENCES HOADON(SoHD),
	FOREIGN KEY (MaNGK) REFERENCES NGK(MaNGK),
);

CREATE TABLE PHIEUHEN (
	SoPH VARCHAR(6) PRIMARY KEY NOT NULL,
	NgayLapPH DATE,
	NgayHenGiao DATE,
	MaKH VARCHAR(6) REFERENCES KH(MaKH),
);

CREATE TABLE CT_PH (
	SoPH VARCHAR(6),
	MaNGK VARCHAR(6),
	SLHen INT,
	PRIMARY KEY (SoPH, MaNGK),
	FOREIGN KEY (SoPH) REFERENCES PHIEUHEN(SoPH),
	FOREIGN KEY (MaNGK) REFERENCES NGK(MaNGK),
);

CREATE TABLE PHIEUTRANO (
	SoPTN VARCHAR(6) PRIMARY KEY NOT NULL,
	NgayTra DATE,
	SoTienTra MONEY,
	SoHD VARCHAR(6) REFERENCES HOADON(SoHD),
);


/*INSERT TABLE NHACC*/
INSERT INTO NHACC(MaNCC,TenNCC,DiaChiNCC,DTNCC) 
VALUES ('NC1','Công ty NGK quốc tế CocaCola','Xa lộ Hà Nội, Thủ Đức, TP.HCM','088967908');
INSERT INTO NHACC(MaNCC,TenNCC,DiaChiNCC,DTNCC) 
VALUES ('NC2','Công ty NGK quốc tế Pepsi','Bến Chương Dương, Quận 1, TP.HCM','083663366');
INSERT INTO NHACC(MaNCC,TenNCC,DiaChiNCC,DTNCC) 
VALUES ('NC3','Công ty NGK Bến Chương Dương','Hàm Tử, Q.5, TP.HCM','089456677');

/*INSERT TABLE KH*/
INSERT INTO KH(MaKH,TenKH,DCKH,DTKH)
VALUES ('KH01','Cửa hàng BT','144 XVNT','088405996');
INSERT INTO KH(MaKH,TenKH,DCKH,DTKH)
VALUES ('KH02','Cửa hàng Trà','198/42 NTT','085974572');
INSERT INTO KH(MaKH,TenKH,DCKH,DTKH)
VALUES ('KH03','Siêu thị coop','24 ĐTH','086547888');

/*INSERT TABLE LOAINGK*/
INSERT INTO LOAINGK(MaLoaiNGK,TenLoaiNGK,MaNCC)
VALUES ('NK1','Nước ngọt có gas','NC1');
INSERT INTO LOAINGK(MaLoaiNGK,TenLoaiNGK,MaNCC)
VALUES ('NK2','Nước ngọt không gas','NC2');
INSERT INTO LOAINGK(MaLoaiNGK,TenLoaiNGK,MaNCC)
VALUES ('NK3','Trà','NC1');
INSERT INTO LOAINGK(MaLoaiNGK,TenLoaiNGK,MaNCC)
VALUES ('NK4','Sữa','NC2');

/*INSERT TABLE NGK*/
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('CC1','Coca Cola','Chai','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('CC2','Coca Cola','Lon','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('PS1','Pepsi','Chai','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('PS2','Pepsi','Lon','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('SV1','Seven Up','Chai','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('SV2','Seven Up','Lon','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('NO1','Number One','Chai','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('NO2','Number One','Lon','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('ST1','Sting dâu','Chai','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('ST2','Sting dâu','Lon','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('C2','Trà C2','Chai','NK2');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('OD','Trà xanh 0 độ','Chai','NK2');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('ML1','Sữa tươi tiệt trùng','Bịch','NK1');
INSERT INTO NGK(MaNGK,TenNGK,Quycach,MaLoaiNGK)
VALUES ('WT1','Nước uống đóng chai','Chai','NK2');

SET DATEFORMAT dmy;
/*INSERT TABLE DDH*/
INSERT INTO DDH(SoDDH,NgayDH,MaNCC)
VALUES ('DDH01','10/5/2011','NC1');
INSERT INTO DDH(SoDDH,NgayDH,MaNCC)
VALUES ('DDH02','20/5/2011','NC1');
INSERT INTO DDH(SoDDH,NgayDH,MaNCC)
VALUES ('DDH03','26/5/2011','NC2');
INSERT INTO DDH(SoDDH,NgayDH,MaNCC)
VALUES ('DDH04','03/6/2011','NC2');

/*INSERT TABLE CT_DDH*/
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH01','CC1',20);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH01','CC2',15);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH01','PS1',18);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH01','SV2',12);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH02','CC2',30);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH02','PS2',10);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH02','SV1',5);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH02','ST1',15);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH02','C2',10);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH03','OD',45);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH04','CC1',8);
INSERT INTO CT_DDH(SoDDH,MaNGK,SLDat)
VALUES ('DDH04','ST2',12);

/*INSERT TABLE PHIEUGH*/
INSERT INTO PHIEUGH(SoPGH,NgayGH,SoDDH)
VALUES ('PGH01','12/5/2010','DDH01');
INSERT INTO PHIEUGH(SoPGH,NgayGH,SoDDH)
VALUES ('PGH02','15/5/2010','DDH01');
INSERT INTO PHIEUGH(SoPGH,NgayGH,SoDDH)
VALUES ('PGH03','21/5/2010','DDH02');
INSERT INTO PHIEUGH(SoPGH,NgayGH,SoDDH)
VALUES ('PGH04','22/5/2010','DDH02');
INSERT INTO PHIEUGH(SoPGH,NgayGH,SoDDH)
VALUES ('PGH05','28/5/2010','DDH03');

/*INSERT TABLE CT_PGH*/
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH01','CC1',15,5000);
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH01','CC2',15,4000);
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH01','SV2',10,4000);
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH02','SV2',2,4000);
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH03','CC2',30,5000);
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH03','PS2',10,4000);
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH03','ST1',15,9000);
INSERT INTO CT_PGH(SoPGH,MaNGK,SLGiao,DGGiao)
VALUES ('PGH03','C2',10,8000);

/*INSERT TABLE HOADON*/
INSERT INTO HOADON(SoHD,NgaylapHD,MaKH)
VALUES ('HD01','10/5/2010','KH01');
INSERT INTO HOADON(SoHD,NgaylapHD,MaKH)
VALUES ('HD02','20/5/2010','KH01');
INSERT INTO HOADON(SoHD,NgaylapHD,MaKH)
VALUES ('HD03','05/6/2010','KH02');
INSERT INTO HOADON(SoHD,NgaylapHD,MaKH)
VALUES ('HD04','16/6/2010','KH02');
INSERT INTO HOADON(SoHD,NgaylapHD,MaKH)
VALUES ('HD05','22/6/2010','KH02');
INSERT INTO HOADON(SoHD,NgaylapHD,MaKH)
VALUES ('HD06','8/7/2010','KH03');

/*INSERT TABLE CT_HOADON*/
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD01','CC1',20,6000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD01','CC2',50,5000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD02','ST1',40,10000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD03','SV2',60,5000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD04','PS2',25,5000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD05','CC1',100,6000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD05','SV1',12,8000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD05','C2',80,9000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD06','OD',55,1000);
INSERT INTO CT_HOADON(SoHD,MaNGK,SLKHMua,DGBan)
VALUES ('HD06','ST2',50,11000);

/*INSERT TABLE PHIEUHEN*/
INSERT INTO PHIEUHEN(SoPH,NgayLapPH,NgayHenGiao,MaKH)
VALUES ('PH01','08/5/2010','09/6/2010','KH01');
INSERT INTO PHIEUHEN(SoPH,NgayLapPH,NgayHenGiao,MaKH)
VALUES ('PH02','25/5/2010','28/6/2010','KH02');
INSERT INTO PHIEUHEN(SoPH,NgayLapPH,NgayHenGiao,MaKH)
VALUES ('PH03','01/6/2010','02/6/2010','KH03');

/*INSERT TABLE CT_PH*/
INSERT INTO CT_PH(SoPH, MaNGK,SLHen)
VALUES ('PH01','ST2',10);
INSERT INTO CT_PH(SoPH, MaNGK,SLHen)
VALUES ('PH01','OD',8);
INSERT INTO CT_PH(SoPH, MaNGK,SLHen)
VALUES ('PH02','CC1',20);
INSERT INTO CT_PH(SoPH, MaNGK,SLHen)
VALUES ('PH03','ST1',7);
INSERT INTO CT_PH(SoPH, MaNGK,SLHen)
VALUES ('PH03','SV2',12);
INSERT INTO CT_PH(SoPH, MaNGK,SLHen)
VALUES ('PH03','CC2',9);
INSERT INTO CT_PH(SoPH, MaNGK,SLHen)
VALUES ('PH02','PS2',15);

/*INSERT TABLE PHIEUTRANO*/
INSERT INTO PHIEUTRANO(SoPTN,NgayTra,SoTienTra,SoHD)
VALUES ('PTN01','18/5/2010',500000,'HD01');
INSERT INTO PHIEUTRANO(SoPTN,NgayTra,SoTienTra,SoHD)
VALUES ('PTN02','01/6/2010',350000,'HD01');
INSERT INTO PHIEUTRANO(SoPTN,NgayTra,SoTienTra,SoHD)
VALUES ('PTN03','02/6/2010',650000,'HD02');
INSERT INTO PHIEUTRANO(SoPTN,NgayTra,SoTienTra,SoHD)
VALUES ('PTN04','15/6/2010',1020000,'HD03');
INSERT INTO PHIEUTRANO(SoPTN,NgayTra,SoTienTra,SoHD)
VALUES ('PTN05','01/7/2010',1080000,'HD03');

/*1) Liệt kê các NGK và loại NGK tương ứng.*/
USE EX2
GO
SELECT *
FROM NGK INNER JOIN LOAINGK ON NGK.MaLoaiNGK = LOAINGK.MaLoaiNGK;
/*2) Cho biết thông tin về nhà cung cấp ở Thành phố HCM.*/
USE EX2
GO
SELECT *
FROM NHACC 
WHERE DiaChiNCC LIKE '%TP.HCM%';
/*3) Liệt kê các hóa đơn mua hàng trong tháng 5/2010.*/
USE EX2
GO 
SELECT *
FROM HOADON
WHERE (MONTH(NgaylapHD) = 5) AND (YEAR(NgaylapHD) = 2010);
/*4) Cho biết tên các nhà cung cấp có cung cấp NGK ‘Coca Cola’.*/
USE EX2
GO
SELECT DISTINCT NHACC.TENNCC
FROM NHACC INNER JOIN LOAINGK ON NHACC.MaNCC = LOAINGK.MaNCC
		INNER JOIN NGK ON NGK.MaLoaiNGK = LOAINGK.MaLoaiNGK
WHERE NGK.TenNGK ='Coca Cola';
/*5) Cho biết tên các nhà cung cấp có thể cung cấp nhiều loại NGK nhất.*/
USE EX2
GO
SELECT NHACC.TenNCC, COUNT(NGK.MALOAINGK) AS SO_LUONG
FROM NHACC INNER JOIN LOAINGK ON NHACC.MaNCC = LOAINGK.MaNCC
		INNER JOIN NGK ON NGK.MaLoaiNGK = LOAINGK.MaLoaiNGK
GROUP BY NHACC.TenNCC
HAVING COUNT(NGK.MALOAINGK) >= ALL (SELECT COUNT(NGK.MALOAINGK)
									FROM NHACC INNER JOIN LOAINGK ON NHACC.MaNCC = LOAINGK.MaNCC
											INNER JOIN NGK ON NGK.MaLoaiNGK = LOAINGK.MaLoaiNGK
									GROUP BY NHACC.TenNCC);
/*6) Cho biết tên nhà cung cấp không có khả năng cung cấp NGK có tên ‘Pepsi’.*/
USE EX2
GO
SELECT DISTINCT NHACC.TenNCC
FROM NHACC 
WHERE NHACC.TenNCC NOT IN (SELECT NHACC.TenNCC
						FROM NHACC INNER JOIN LOAINGK ON NHACC.MaNCC = LOAINGK.MaNCC
									INNER JOIN NGK ON NGK.MaLoaiNGK = LOAINGK.MaLoaiNGK
						WHERE NGK.TenNGK = 'Pepsi');
/*7) Hiển thị thông tin của NGK chưa bán được.*/
USE EX2
GO
SELECT *
FROM NGK
WHERE (MaNGK NOT IN (
	SELECT NGK.MaNGK
	FROM NGK INNER JOIN CT_DDH ON NGK.MaNGK = CT_DDH.MaNGK
))AND(MaNGK NOT IN (
	SELECT NGK.MaNGK
	FROM NGK INNER JOIN CT_HOADON ON NGK.MaNGK = CT_HOADON.MaNGK
))AND(MaNGK NOT IN (
	SELECT NGK.MaNGK
	FROM NGK INNER JOIN CT_PGH ON NGK.MaNGK = CT_PGH.MaNGK
))AND(MaNGK NOT IN (
	SELECT NGK.MaNGK
	FROM NGK INNER JOIN CT_PH ON NGK.MaNGK = CT_PH.MaNGK
));
/*8) Hiển thị tên và tổng số lượng bán của từng NGK.*/
USE EX2
GO
(
SELECT NGK.MaNGK, SUM(CT_DDH.SLDat) AS SL
FROM NGK INNER JOIN CT_DDH ON NGK.MaNGK = CT_DDH.MaNGK
GROUP BY NGK.MaNGK
UNION
SELECT NGK.MaNGK, SUM(CT_HOADON.SLKHMua) AS SL
FROM NGK INNER JOIN CT_HOADON ON NGK.MaNGK = CT_HOADON.MaNGK
GROUP BY NGK.MaNGK
UNION
SELECT NGK.MaNGK, SUM(CT_PGH.SLGiao) AS SL
FROM NGK INNER JOIN CT_PGH ON NGK.MaNGK = CT_PGH.MaNGK
GROUP BY NGK.MaNGK
UNION
SELECT NGK.MaNGK, SUM(CT_PH.SLHen) AS SL
FROM NGK INNER JOIN CT_PH ON NGK.MaNGK = CT_PH.MaNGK
GROUP BY NGK.MaNGK
);
/*9) Hiển thị tên và tổng số lượng của NGK nhập về.*/
/*10) Hiển thị ĐĐH đã đặt NGK với số lượng nhiều nhất so với các ĐĐH khác có đặt NGK đó. Thông tin 
hiển thị: SoDDH, MaNGK, [SL đặt nhiều nhất].*/
/*11) Hiển thị các NGK không được nhập trong tháng 1/2010.*/
/*12) Hiển thị tên các NGK không bán được trong tháng 6/2010.*/
/*13) Cho biết cửa hàng bán bao nhiêu thứ NGK.*/
/*14) Cho biết cửa hàng bán bao nhiêu loại NGK.*/
/*15) Hiển thị thông tin của khách hàng có giao dịch với cửa hàng nhiều nhất (căn cứ vào số lần mua 
hàng).*/
/*16) Tính tổng doanh thu năm 2010 của cửa hàng.*/
/*17) Liệt kê 5 loại NGK bán chạy nhất (doanh thu) trong tháng 5/2010.*/
/*18) Liệt kê thông tin bán NGK của tháng 5/2010. Thông tin hiển thị: Mã NGK, Tên NGK, SL bán.*/
/*19) Liệt kê thông tin của NGK có nhiều người mua nhất.*/
/*20) Hiển thị ngày nhập hàng gần nhất của cửa hàng.*/
/*21) Cho biết số lần mua hàng của khách có mã là ‘KH001’.*/
/*22) Cho biết tổng tiền của từng hóa đơn.*/
/*23) Cho biết danh sách các hóa đơn gồm SoHD, NgaylapHD, MaKH, TenKH và tổng trị giá của từng 
HoaDon. Danh sách sắp xếp tăng dần theo ngày và giảm dần theo tổng trị giá của hóa đơn.*/
/*24) Cho biết các hóa đơn có tổng trị giá lớn hơn tổng trị giá trung bình của các hóa đơn trong ngày 
18/06/2010.*/
/*25) Cho biết số lượng từng NGK tiêu thụ theo từng tháng của năm 2010.*/
/*26) Đưa ra danh sách NGK chưa được bán trong tháng 9 năm 2010.*/
/*27) Đưa ra danh sách khách hàng có địa chỉ ở TP.HCM và từng mua NGK trong tháng 9 năm 2010.*/
/*28) Đưa ra số lượng đã bán tương ứng của từng NGK trong tháng 10 năm 2010.*/
/*29) Hiển thị thông tin khách hàng đã từng mua và tổng số lượng của từng NGK tại cửa hàng.*/
/*30) Cho biết trong năm 2010, khách hàng nào đã mua nợ nhiều nhất.*/
/*31) Có bao nhiêu hóa đơn chưa thanh toán hết số tiền?*/
/*32) Liệt kê các hóa đơn cùng tên của khách hàng tương ứng đã mua NGK và thanh toán tiền đầy đủ 1 
lần. (Không có phiếu trả nợ)*/
/*33) Thông kê cho biết thông tin đặt hàng của cửa hàng trong năm 2010: Mã NGK, Tên NGK, Tổng SL 
đặt*/
/*34) Để thuận tiện trong việc tặng quà Tết cho khách hàng, hãy liệt kê danh sách khách
hàng đã mua NGK với tổng số tiền tương ứng trong năm 2010 (hiển thị giảm dần theo số tiền đã mua)*/
